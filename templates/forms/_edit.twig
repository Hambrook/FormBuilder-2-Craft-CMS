{% extends "_layouts/cp" %}
{% import "_includes/forms" as forms %}

{% set bodyClass = 'formbuilder fb-new-form' %}
{% set pageSlug = craft.request.lastSegment %}

{# Page Header | Reference craft/app/templates/_layouts/cp.html #}
{% block pageHeader %}
  {# {{ parent() }} #}
  {% include 'formbuilder2/partials/header' %}
{% endblock %}

{# Main Container | Reference craft/app/templates/_layouts/cp.html #}
{% block main %}
  {% if pageSlug == 'edit' %}
    {% set page = 'Edit Form' %}
  {% else %}
    {% set page = 'New Form' %}
  {% endif %}

  {% include 'formbuilder2/partials/sidebar' %} 

  <section id="fb-content">
    <header class="page-header">
      <h1><svg class="icon"><use xlink:href="#icon-edit" class="icon-edit"/></svg> {{ page|t }}</h1>
    </header>

    <div class="forms pane">
      <form method="post" accept-charset="UTF-8" data-saveshortcut="1">
        <input type="hidden" name="action" value="formBuilder2/form/saveForm">
        <input type="hidden" name="redirect" value="formbuilder2/forms">

        {% if form.id %}<input type="hidden" name="formId" value="{{ form.id }}">{% endif %}
        
        <div class="menu-tabs">
          <h2 class="current"><a href="#form-settings">{{ "Form Settings"|t }}</a></h2>
          <h2><a href="#spam-protection">{{ "Spam Protection"|t }}</a></h2>
          <h2><a href="#messages">{{ "Messages"|t }}</a></h2>
          <h2><a href="#notifications">{{ "Notifications"|t }}</a></h2>
          <h2><a href="#fields">{{ "Fields"|t }}</a></h2>
        </div>

        <div class="tabs-container">

          <div id="form-settings" class="tab-content">
            {{ forms.textField({
              first: true,
              label: "Form Name"|t,
              instructions: "Give this form a name."|t,
              id: 'name',
              name: 'name',
              value: form.name,
              errors: form.getErrors('name'),
              autofocus: true,
              required: true,
              size: 50,
              translatable: true
            }) }}

            {{ forms.textField({
              label: "Handle"|t,
              instructions: "How youâ€™ll refer to this form in the templates."|t,
              id: 'handle',
              class: 'code',
              name: 'handle',
              value: form.handle,
              size: 50,
              errors: form.getErrors('handle'),
              required: true
            }) }}

            {{ forms.textField({
              label: "Email Subject"|t,
              instructions: "Subject line for email notifications."|t,
              id: 'emailSubject',
              class: 'emailSubject',
              name: 'emailSubject',
              value: form.emailSubject,
              size: 50,
              errors: form.getErrors('emailSubject'),
              required: false
            }) }}

            {{ forms.textField({
              label: "Redirect URL"|t,
              instructions: "Enter url to success page"|t,
              id: 'redirectUrl',
              class: 'redirectUrl',
              name: 'redirectUrl',
              value: form.redirectUrl,
              size: 50,
              errors: form.getErrors('redirectUrl'),
              required: false
            }) }}

            <div class="heading">
              <label for="ajaxSubmit">{{ "Use AJAX?"|t }}</label>
              <div class="instructions switch"><p>{{ "Should we submit the form via ajax?"|t }}</p></div>
            </div>
            {{ forms.lightswitch({
              name:     "ajaxSubmit",
              onLabel:  "On",
              offLabel: "Off",
              on: (form.ajaxSubmit is defined) ? form.ajaxSubmit : ""
            }) }}

          </div>

          <div id="spam-protection" class="tab-content">


            <div class="method-time pane">

              <div class="checkbox-toggle">
                <div class="togglebox">
                  <svg><use xlink:href="#icon-clock" class="icon-clock"/></svg>
                  <input type="checkbox" value="1" {% if form.spamTimeMethod %} checked {% endif %}id="spamTimeMethod" class="spamTimeMethod checkbox" name="spamTimeMethod">
                </div>
                <div class="togglecontent">
                  <h3>{{ "Timed Submissions"|t }}</h3>
                  <p>{{ "Allow minimum time to submit a form."|t }}</p>
                </div>
              </div>


            {#   {{ forms.checkboxField({
                label: "Timed Submissions?"|t,
                instructions: "Allow minimum time to submit a form."|t,
                id: 'spamTimeMethod',
                class: 'spamTimeMethod',
                name: 'spamTimeMethod',
                value: 1,
                checked: form.spamTimeMethod,
                errors: form.getErrors('spamTimeMethod'),
                required: false
              }) }}
 #}

              {# {{ forms.textField({
                label: "Time"|t,
                instructions: "Enter how many seconds to wait untill submissions are valid."|t,
                id: 'spamTimeMethodTime',
                class: 'spamTimeMethodTime',
                name: 'spamTimeMethodTime',
                value: form.spamTimeMethodTime,
                size: 50,
                errors: form.getErrors('spamTimeMethodTime'),
                required: false
              }) }} #}
            </div>

            <div class="heading">
              <label for="name">{{ "Honeypot"|t }}</label>
              <div class="instructions switch"><p>{{ "String matching spam protection."|t }}</p></div>
            </div>
            {{ forms.lightswitch({
              id: 'spamHoneypotMethod',
              class: 'spamHoneypotMethod',
              name: "spamHoneypotMethod",
              onLabel: "On",
              offLabel: "Off",
              value: form.spamHoneypotMethod,
              on: (settings.spamHoneypotMethod is defined) ? settings.spamHoneypotMethod : ""
            }) }}

            <div class="honeypot-method">
              {{ forms.textField({
                label: "Honeypot String"|t,
                instructions: "Enter string to validate against."|t,
                id: 'spamHoneypotMethodString',
                class: 'spamHoneypotMethodString',
                name: 'spamHoneypotMethodString',
                value: form.spamHoneypotMethodString,
                size: 50,
                errors: form.getErrors('spamHoneypotMethodString'),
                required: false
              }) }}

              {{ forms.textField({
                label: "Honeypot Input Message"|t,
                instructions: "Enter message for screen readers."|t,
                id: 'spamHoneypotMethodMessage',
                class: 'spamHoneypotMethodMessage',
                name: 'spamHoneypotMethodMessage',
                value: form.spamHoneypotMethodMessage,
                size: 50,
                errors: form.getErrors('spamHoneypotMethodMessage'),
                required: false
              }) }}
            </div>
          </div>

          <div id="messages" class="tab-content">
            {{ forms.textField({
              label: "Success Message"|t,
              instructions: "Please enter success message."|t,
              id: 'successMessage',
              class: 'successMessage',
              name: 'successMessage',
              value: form.successMessage,
              size: 100,
              errors: form.getErrors('successMessage'),
              required: false
            }) }}

            {{ forms.textField({
              label: "Error Message"|t,
              instructions: "Please enter error message."|t,
              id: 'errorMessage',
              class: 'errorMessage',
              name: 'errorMessage',
              value: form.errorMessage,
              size: 100,
              errors: form.getErrors('errorMessage'),
              required: false
            }) }}
          </div>

          <div id="notifications" class="tab-content">
            {# {{ forms.checkboxField({
              label: "Send Notification?"|t,
              instructions: "Should the form send notification to form owner?"|t,
              id: 'notifyFormAdmin',
              class: 'notifyFormAdmin',
              name: 'notifyFormAdmin',
              value: 1,
              checked: form.notifyFormAdmin,
              errors: form.getErrors('notifyFormAdmin'),
              required: false
            }) }} #}
          </div>
          <div id="fields" class="tab-content">
            {% include "formbuilder2/inputs/fieldlayoutdesigner" with {
              fieldLayout: form.getFieldLayout(),
              customizableTabs: true
            } only %}
          </div>

        </div>

        <div class="buttons">
          <input type="submit" class="btn submit" value="{{ 'Save'|t }}">
        </div>

      </form>

    </div>

    {# No Forms #}
    <div class="no-forms" style="display: none;">
      <p>{{ "Hello! You don't have any forms yet."|t }}</p>
      <a href="#" class="create-form-button"><svg><use xlink:href="#icon-text" class="icon-text"/></svg> <span>{{ "Create a Form"|t }}</span></a>
    </div>

  </section>

{% endblock %}

{% set newFormJs %}
  {% if not form.handle %}new Craft.HandleGenerator('#name', '#handle');{% endif %}
    
  if ($('#spamTimeMethod').is(":checked")) {
    $(".checkbox-toggle").addClass('selected')
  }

  $(".checkbox-toggle").on('click', function() {
    $(this).toggleClass('selected');
    if ($(this).hasClass('selected')) {
      console.log('has class selected');
      $('#spamTimeMethod').prop('checked', true);
    } else {
    $('#spamTimeMethod').prop('checked', false);
      console.log('not selected');
    }
  });


  {# $("#spamTimeMethod").on('change', function() {
    console.log('changed');
  });

  $('input[name="spamHoneypotMethod"]').on('change', function() {
    $('.honeypot-method').slideToggle();
  }); #}
{% endset %}
{% includeJs newFormJs %}
